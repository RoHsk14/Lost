{% extends 'base.html' %}
{% load static %}

{% block title %}Mon Tableau de Bord{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                üëã Bonjour, {{ user.username }}
            </h1>
            <p class="text-gray-600 text-lg">
                Voici un aper√ßu de vos activit√©s r√©centes
            </p>
        </div>

        <!-- Statistiques Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div
                class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500 transform hover:scale-105 transition-transform">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        üìã
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.mes_signalements_total }}</p>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500 transform hover:scale-105 transition-transform">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        üòû
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Perdus</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.mes_perdus }}</p>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500 transform hover:scale-105 transition-transform">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        üéâ
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Trouv√©s</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.mes_trouves }}</p>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500 transform hover:scale-105 transition-transform">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        ‚úÖ
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Retourn√©s</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.mes_retournes }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üöÄ Actions rapides</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="{% url 'signalement_add' %}"
                    class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg text-center hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105">
                    <div class="text-2xl mb-2">‚ûï</div>
                    <div class="font-semibold">Nouveau signalement</div>
                </a>

                <a href="{% url 'mes_signalements' %}"
                    class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg text-center hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105">
                    <div class="text-2xl mb-2">üìã</div>
                    <div class="font-semibold">Mes signalements</div>
                </a>

                <a href="{% url 'utilisateur_profil' %}"
                    class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg text-center hover:from-purple-600 hover:to-purple-700 transition-all transform hover:scale-105">
                    <div class="text-2xl mb-2">üë§</div>
                    <div class="font-semibold">Mon profil</div>
                </a>

                <a href="{% url 'search_objets' %}"
                    class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg text-center hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105">
                    <div class="text-2xl mb-2">üîç</div>
                    <div class="font-semibold">Rechercher</div>
                </a>
            </div>
        </div>

        <!-- Chat avec les agents (nouveau) -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    üí¨ Mes conversations avec les agents
                    <span id="chat-unread-badge"
                        class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full hidden">0</span>
                </h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Liste des conversations -->
                <div class="lg:col-span-1">
                    <div id="user-conversations" class="space-y-3 max-h-64 overflow-y-auto border rounded-lg p-2">
                        <div class="p-4 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl"></i>
                            <p class="mt-2">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Zone de chat -->
                <div class="lg:col-span-2">
                    <div id="user-chat-area" class="border rounded-lg h-80 flex flex-col">
                        <div id="user-chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50">
                            <div class="text-center text-gray-500 mt-8">
                                <i class="fas fa-comments text-4xl text-gray-300 mb-2"></i>
                                <p>S√©lectionnez une conversation ou cr√©ez-en une nouvelle</p>
                                <p class="text-sm mt-2">Vous pouvez d√©marrer une conversation depuis la page d'un de vos
                                    signalements</p>
                            </div>
                        </div>

                        <!-- Zone de saisie -->
                        <div id="user-chat-input-area" class="p-4 border-t bg-white hidden">
                            <div class="flex space-x-2">
                                <input type="file" id="user-chat-file-input" accept="image/*,.pdf,.doc,.docx,.txt"
                                    style="display: none;">
                                <button onclick="document.getElementById('user-chat-file-input').click()"
                                    class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <input type="text" id="user-chat-message-input" placeholder="Tapez votre message..."
                                    class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button id="user-chat-send-btn"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section d'acc√®s rapide aux param√®tres -->
        <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-6 mb-8 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">‚öôÔ∏è G√©rer mon compte</h3>
                    <p class="text-gray-600">Acc√©dez √† vos informations personnelles et pr√©f√©rences</p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'utilisateur_profil' %}"
                        class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition border border-blue-200">
                        üë§ Profil
                    </a>
                    <a href="{% url 'utilisateur_parametres' %}"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                        ‚öôÔ∏è Param√®tres
                    </a>
                </div>
            </div>
        </div>

        <!-- Mes derniers signalements -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üìã Mes derniers signalements</h2>
                    <a href="{% url 'mes_signalements' %}" class="text-blue-600 hover:text-blue-800 font-medium">
                        Voir tout ‚Üí
                    </a>
                </div>

                {% if mes_signalements %}
                <div class="space-y-4">
                    {% for signalement in mes_signalements %}
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">{{ signalement.objet.nom }}</h3>
                                <p class="text-gray-600 text-sm mt-1">{{ signalement.lieu_precis|default:"Lieu non
                                    pr√©cis√©" }}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    {{ signalement.date_signalement|date:"d/m/Y H:i" }}
                                </p>
                            </div>
                            <div class="ml-4">
                                {% if signalement.statut == 'perdu' %}
                                <span class="px-3 py-1 bg-red-100 text-red-800 text-xs rounded-full">
                                    üòû Perdu
                                </span>
                                {% elif signalement.statut == 'trouve' %}
                                <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    üéâ Trouv√©
                                </span>
                                {% else %}
                                <span class="px-3 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">
                                    ‚úÖ Retourn√©
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p class="text-gray-600">Aucun signalement pour le moment</p>
                    <a href="{% url 'signalement_add' %}"
                        class="inline-block mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Cr√©er mon premier signalement
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Signalements r√©cents de la communaut√© -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üåü Activit√© r√©cente</h2>

                {% if signalements_recents %}
                <div class="space-y-4">
                    {% for signalement in signalements_recents %}
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">{{ signalement.objet.nom }}</h3>
                                <p class="text-gray-600 text-sm mt-1">{{ signalement.lieu_precis|default:"Lieu non
                                    pr√©cis√©" }}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    Par {{ signalement.utilisateur.username|default:"Anonyme" }} ‚Ä¢
                                    {{ signalement.date_signalement|date:"d/m/Y" }}
                                </p>
                            </div>
                            <div class="ml-4">
                                {% if signalement.statut == 'perdu' %}
                                <span class="px-3 py-1 bg-red-100 text-red-800 text-xs rounded-full">
                                    üòû Perdu
                                </span>
                                {% elif signalement.statut == 'trouve' %}
                                <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    üéâ Trouv√©
                                </span>
                                {% else %}
                                <span class="px-3 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">
                                    ‚úÖ Retourn√©
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="text-6xl mb-4">üåô</div>
                    <p class="text-gray-600">Aucune activit√© r√©cente</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Initialisation du chat dashboard pour utilisateurs
    let userChatSocket = null;
    let userNotificationSocket = null;
    let currentUserConversation = null;

    document.addEventListener('DOMContentLoaded', function () {
        initializeUserDashboardChat();
        connectUserNotifications();

        // Gestionnaire pour le fichier joint
        document.getElementById('user-chat-file-input').addEventListener('change', handleUserFileUpload);

        // Gestionnaire pour l'envoi de message
        document.getElementById('user-chat-send-btn').addEventListener('click', sendUserMessage);
        document.getElementById('user-chat-message-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendUserMessage();
            }
        });
    });

    function initializeUserDashboardChat() {
        loadUserConversations();
    }

    function connectUserNotifications() {
        const notificationSocketUrl = `ws://${window.location.host}/ws/notifications/`;
        userNotificationSocket = new WebSocket(notificationSocketUrl);

        userNotificationSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            if (data.type === 'new_message') {
                updateUserUnreadCount();
                loadUserConversations(); // Recharger pour mettre √† jour les indicateurs

                // Si c'est pour la conversation actuelle, afficher le message
                if (currentUserConversation && data.conversation_id == currentUserConversation) {
                    loadUserMessages(currentUserConversation);
                }
            }
        };
    }

    function loadUserConversations() {
        fetch('/api/conversations/')
            .then(response => response.json())
            .then(conversations => {
                const conversationsDiv = document.getElementById('user-conversations');

                if (conversations.length === 0) {
                    conversationsDiv.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-comments text-2xl text-gray-300"></i>
                        <p class="mt-2">Aucune conversation</p>
                        <p class="text-sm">Cr√©ez une conversation depuis la page d'un signalement</p>
                    </div>
                `;
                    return;
                }

                conversationsDiv.innerHTML = conversations.map(conv => `
                <div class="conversation-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 ${conv.id == currentUserConversation ? 'bg-blue-100 border-blue-300' : ''}"
                     onclick="selectUserConversation(${conv.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-gray-900 truncate">
                                Signalement #${conv.signalement_numero}
                            </h3>
                            <p class="text-sm text-gray-600 truncate">
                                ${conv.derniere_activite ? 'Derni√®re activit√©: ' + new Date(conv.derniere_activite).toLocaleDateString() : 'Nouvelle conversation'}
                            </p>
                        </div>
                        ${conv.unread_count > 0 ? `
                            <span class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">
                                ${conv.unread_count}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `).join('');

                updateUserUnreadCount();
            });
    }

    function selectUserConversation(conversationId) {
        currentUserConversation = conversationId;

        // Mettre √† jour l'apparence des conversations
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('bg-blue-100', 'border-blue-300');
        });
        event.target.closest('.conversation-item').classList.add('bg-blue-100', 'border-blue-300');

        // Connecter au WebSocket de la conversation
        connectUserChatSocket(conversationId);

        // Charger les messages
        loadUserMessages(conversationId);

        // Afficher la zone de saisie
        document.getElementById('user-chat-input-area').classList.remove('hidden');

        // Marquer comme lu
        markUserConversationAsRead(conversationId);
    }

    function connectUserChatSocket(conversationId) {
        if (userChatSocket) {
            userChatSocket.close();
        }

        console.log('üîå Connexion WebSocket utilisateur pour conversation:', conversationId);
        const chatSocketUrl = `ws://${window.location.host}/ws/chat/${conversationId}/`;
        userChatSocket = new WebSocket(chatSocketUrl);

        userChatSocket.onopen = function (e) {
            console.log('‚úÖ WebSocket utilisateur connect√©');
        };

        userChatSocket.onmessage = function (e) {
            console.log('üì® Message re√ßu via WebSocket utilisateur:', e.data);
            const data = JSON.parse(e.data);

            if (data.type === 'message') {
                appendUserMessage(data.data);
                // Actualiser le compteur de messages non lus
                updateUserUnreadCount();
            } else if (data.type === 'error') {
                console.error('‚ùå Erreur WebSocket utilisateur:', data.message);
                alert('Erreur: ' + data.message);
            } else {
                console.log('üì® Type de message non g√©r√© utilisateur:', data.type, data);
            }
        };

        userChatSocket.onerror = function (e) {
            console.error('‚ùå Erreur WebSocket utilisateur:', e);
        };

        userChatSocket.onclose = function (e) {
            console.log('üîå WebSocket utilisateur ferm√©:', e.code, e.reason);
            if (e.code !== 1000) {
                console.warn('‚ö†Ô∏è Connexion utilisateur ferm√©e de mani√®re inattendue');
            }
        };
    }

    function loadUserMessages(conversationId) {
        fetch(`/api/conversations/${conversationId}/messages/`)
            .then(response => response.json())
            .then(messages => {
                const messagesDiv = document.getElementById('user-chat-messages');
                messagesDiv.innerHTML = '';

                messages.forEach(message => {
                    appendUserMessage(message);
                });

                // Scroll vers le bas
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
    }

    function appendUserMessage(message) {
        const messagesDiv = document.getElementById('user-chat-messages');
        const isFromCurrentUser = message.expediteur === '{{ user.id }}' || message.expediteur === {{ user.id }
    };

    const messageElement = document.createElement('div');
    messageElement.className = `mb-4 ${isFromCurrentUser ? 'text-right' : 'text-left'}`;
    messageElement.setAttribute('data-message-id', message.id);

    // V√©rifier si ce message existe d√©j√† (√©viter les doublons)
    const existingMessage = messagesDiv.querySelector(`[data-message-id="${message.id}"]`);
    if (existingMessage && !message.isTemporary) {
        return; // Message d√©j√† affich√©
    }

    let fileHtml = '';
    if (message.fichier_joint) {
        const fileName = message.fichier_joint.split('/').pop();
        const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(fileName);

        if (isImage) {
            fileHtml = `
                <div class="mb-2">
                    <img src="${message.fichier_joint}" alt="${fileName}" 
                         class="max-w-xs rounded-lg cursor-pointer" 
                         onclick="window.open('${message.fichier_joint}', '_blank')">
                </div>
            `;
        } else {
            fileHtml = `
                <div class="mb-2">
                    <a href="${message.fichier_joint}" target="_blank" 
                       class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                        <i class="fas fa-paperclip mr-2"></i>
                        ${fileName}
                    </a>
                </div>
            `;
        }
    } else if (message.fichier) {
        // Nouvelle structure pour les fichiers
        const fileName = message.fichier.nom || message.fichier.split('/').pop();
        const fileUrl = message.fichier.url || message.fichier;
        const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(fileName);

        if (isImage) {
            fileHtml = `
                <div class="mb-2">
                    <img src="${fileUrl}" alt="${fileName}" 
                         class="max-w-xs rounded-lg cursor-pointer" 
                         onclick="window.open('${fileUrl}', '_blank')">
                </div>
            `;
        } else {
            fileHtml = `
                <div class="mb-2">
                    <a href="${fileUrl}" target="_blank" 
                       class="inline-flex items-center px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                        <i class="fas fa-paperclip mr-2"></i>
                        ${fileName}
                    </a>
                </div>
            `;
        }
    }
    }

    messageElement.innerHTML = `
        <div class="inline-block max-w-xs lg:max-w-md">
            ${fileHtml}
            <div class="px-4 py-2 rounded-lg ${isFromCurrentUser
            ? 'bg-blue-600 text-white'
            : 'bg-gray-200 text-gray-800'
        }">
                <p>${message.contenu}</p>
                <p class="text-xs mt-1 opacity-75">
                    ${new Date(message.date_envoi).toLocaleString()}
                </p>
            </div>
            <p class="text-xs text-gray-500 mt-1">
                ${isFromCurrentUser ? 'Vous' : (message.expediteur_nom || 'Agent')}
            </p>
        </div>
    `;

    //     messagesDiv.appendChild(messageElement);
    //     messagesDiv.scrollTop = messagesDiv.scrollHeight;
    // }

    function sendUserMessage() {
        const input = document.getElementById('user-chat-message-input');
        const message = input.value.trim();

        if (message && currentUserConversation && userChatSocket) {
            console.log('üîç Envoi message utilisateur:', message);

            userChatSocket.send(JSON.stringify({
                'action': 'send_message',
                'message': message
            }));

            input.value = '';
        } else {
            console.warn('‚ùå Impossible d\'envoyer le message utilisateur:', {
                hasMessage: !!message,
                hasConversation: !!currentUserConversation,
                hasSocket: !!userChatSocket,
                socketState: userChatSocket?.readyState
            });
        }
    }

    function handleUserFileUpload() {
        const fileInput = document.getElementById('user-chat-file-input');
        const file = fileInput.files[0];

        if (file && currentUserConversation) {
            console.log('üìé Upload fichier utilisateur:', file.name);

            const formData = new FormData();
            formData.append('fichier', file);
            formData.append('conversation_id', currentUserConversation);

            // Afficher un message temporaire pendant l'upload
            const tempMessage = {
                id: 'temp_' + Date.now(),
                contenu: `üìé Envoi de ${file.name}...`,
                expediteur: '{{ user.id }}',
                expediteur_nom: '{{ user.get_full_name }}',
                created_at: new Date().toISOString(),
                is_from_me: true,
                fichier: null,
                isTemporary: true
            };
            appendUserMessage(tempMessage);

            fetch('/api/upload-file/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log('üìé R√©ponse upload utilisateur:', data);

                    // Supprimer le message temporaire
                    const tempElement = document.querySelector(`[data-message-id="temp_${tempMessage.id.split('_')[1]}"]`);
                    if (tempElement) {
                        tempElement.remove();
                    }

                    if (data.success) {
                        // Le message du fichier devrait arriver via WebSocket
                        // Si ce n'est pas le cas, on force le rechargement des messages
                        setTimeout(() => {
                            if (currentUserConversation) {
                                loadUserMessages(currentUserConversation);
                            }
                        }, 1000);

                        fileInput.value = '';
                    } else {
                        alert('Erreur lors de l\'envoi du fichier: ' + (data.error || 'Erreur inconnue'));
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur upload utilisateur:', error);
                    // Supprimer le message temporaire en cas d'erreur
                    const tempElement = document.querySelector(`[data-message-id="temp_${tempMessage.id.split('_')[1]}"]`);
                    if (tempElement) {
                        tempElement.remove();
                    }
                    alert('Erreur lors de l\'envoi du fichier');
                });
        }
    }
    fileInput.value = '';
            } else {
        alert('Erreur lors de l\'envoi du fichier');
    }
        });
    }
}

    function markUserConversationAsRead(conversationId) {
        fetch(`/api/conversations/${conversationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(() => {
                updateUserUnreadCount();
                loadUserConversations(); // Recharger pour mettre √† jour les badges
            });
    }

    function updateUserUnreadCount() {
        fetch('/api/conversations/')
            .then(response => response.json())
            .then(conversations => {
                const totalUnread = conversations.reduce((sum, conv) => sum + (conv.unread_count || 0), 0);
                const badge = document.getElementById('chat-unread-badge');

                if (totalUnread > 0) {
                    badge.textContent = totalUnread;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
    }
</script>

{% endblock %}