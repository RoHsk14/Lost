{% extends 'base.html' %}

{% block title %}Signaler un objet perdu{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            üîç D√©clarer un objet perdu
        </h1>
        
        {% if messages %}
            {% for message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300{% else %}bg-green-100 text-green-700 border border-green-300{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Section type de d√©claration -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üîñ Type de d√©claration</h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-red-300 transition-colors">
                        <input type="radio" id="type_perdu" name="type_declaration" value="perdu" 
                               {% if not form.type_declaration.value or form.type_declaration.value == 'perdu' %}checked{% endif %}
                               class="mr-3 text-red-600 focus:ring-red-500">
                        <label for="type_perdu" class="flex-1 cursor-pointer">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üò¢</span>
                                <div>
                                    <p class="font-medium text-gray-900">Objet perdu</p>
                                    <p class="text-sm text-gray-600">J'ai perdu quelque chose</p>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-green-300 transition-colors">
                        <input type="radio" id="type_retrouve" name="type_declaration" value="trouve" 
                               {% if form.type_declaration.value == 'trouve' %}checked{% endif %}
                               class="mr-3 text-green-600 focus:ring-green-500">
                        <label for="type_retrouve" class="flex-1 cursor-pointer">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üòä</span>
                                <div>
                                    <p class="font-medium text-gray-900">Objet retrouv√©</p>
                                    <p class="text-sm text-gray-600">J'ai trouv√© quelque chose</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                {% if form.type_declaration.errors %}
                    <div class="mt-2 text-red-500 text-sm">
                        <i class="fas fa-exclamation-circle"></i> {{ form.type_declaration.errors.0 }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Section informations de base -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üìã Informations de base</h2>
                
                <div class="space-y-4">
                    <!-- Nom objet -->
                    <div>
                        <label for="id_nom_objet" class="block text-sm font-medium text-gray-700 mb-1">
                            Nom de l'objet <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="nom_objet" id="id_nom_objet" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ex: iPhone 13, portefeuille en cuir, cl√©s de voiture..."
                               value="{{ form.nom_objet.value|default:'' }}">
                        {% if form.nom_objet.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.nom_objet.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Date incident -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="id_date_incident" class="block text-sm font-medium text-gray-700 mb-1">
                                Date de perte <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="date_incident" id="id_date_incident" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   value="{{ form.date_incident.value|default:'' }}">
                            {% if form.date_incident.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.date_incident.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Lieu pr√©cis -->
                        <div>
                            <label for="id_lieu_precis" class="block text-sm font-medium text-gray-700 mb-1">
                                Lieu pr√©cis <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="lieu_precis" id="id_lieu_precis" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Ex: March√© de Kpalim√©, Gare routi√®re..."
                                   value="{{ form.lieu_precis.value|default:'' }}">
                            {% if form.lieu_precis.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.lieu_precis.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="id_description" class="block text-sm font-medium text-gray-700 mb-1">
                            Description d√©taill√©e
                        </label>
                        <textarea name="description" id="id_description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Couleur, marque, mod√®le, signes particuliers...">{{ form.description.value|default:'' }}</textarea>
                        {% if form.description.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.description.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Section localisation -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üìç Localisation</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- R√©gion -->
                    <div>
                        <label for="id_region" class="block text-sm font-medium text-gray-700 mb-1">
                            R√©gion
                        </label>
                        <select name="region" id="id_region" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Choisir une r√©gion</option>
                            {% for region in regions %}
                                <option value="{{ region.id }}" {% if form.region.value == region.id %}selected{% endif %}>
                                    {{ region.nom }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.region.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.region.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Pr√©fecture -->
                    <div>
                        <label for="id_prefecture" class="block text-sm font-medium text-gray-700 mb-1">
                            Pr√©fecture
                        </label>
                        <select name="prefecture" id="id_prefecture" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                disabled>
                            <option value="">Choisir d'abord une r√©gion</option>
                        </select>
                        {% if form.prefecture.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.prefecture.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Structure -->
                    <div>
                        <label for="id_structure_locale" class="block text-sm font-medium text-gray-700 mb-1">Structure locale</label>
                        <select name="structure_locale" id="id_structure_locale"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                disabled>
                            <option value="">Choisir d'abord une pr√©fecture</option>
                        </select>
                        {% if form.structure_locale.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.structure_locale.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Section photo -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üì∏ Photo</h2>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors" id="dropzone">
                    <div id="upload-content">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg font-medium text-gray-600 mb-2">Cliquez ici ou glissez votre photo</p>
                        <p class="text-sm text-gray-500 mb-4">PNG, JPG, GIF (max 5MB)</p>
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors" onclick="document.getElementById('id_photo_principale').click()">
                            Choisir un fichier
                        </button>
                        <input type="file" name="photo_principale" id="id_photo_principale" accept="image/*" class="hidden">
                    </div>
                    
                    <!-- Aper√ßu -->
                    <div id="preview" class="hidden">
                        <img id="preview-img" src="#" alt="Aper√ßu" class="max-w-xs max-h-48 mx-auto rounded-lg shadow-md mb-4">
                        <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg inline-flex items-center space-x-2 mb-4">
                            <i class="fas fa-check-circle"></i>
                            <span id="file-info">Photo s√©lectionn√©e</span>
                        </div>
                        <br>
                        <button type="button" onclick="removePhoto()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                    
                    <!-- Messages d'erreur -->
                    <div id="photo-error" class="hidden mt-4 bg-red-100 text-red-700 px-4 py-2 rounded-lg">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="error-message"></span>
                    </div>
                </div>
                
                {% if form.photo_principale.errors %}
                    <div class="mt-2 text-red-500 text-sm">
                        <i class="fas fa-exclamation-circle"></i> {{ form.photo_principale.errors.0 }}
                    </div>
                {% endif %}
            </div>

            <!-- Section commentaires -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üí¨ Commentaires suppl√©mentaires</h2>
                
                <div>
                    <label for="id_commentaire_declarant" class="block text-sm font-medium text-gray-700 mb-1">
                        Informations suppl√©mentaires
                    </label>
                    <textarea name="commentaire_declarant" id="id_commentaire_declarant" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Circonstances de la perte, r√©compense, etc...">{{ form.commentaire_declarant.value|default:'' }}</textarea>
                </div>
            </div>

            <!-- Boutons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-medium transition duration-200">
                    üìù D√©clarer la perte
                </button>
                <a href="{% url 'signalements_list' %}" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-medium transition duration-200 text-center">
                    ‚Ü©Ô∏è Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // √âl√©ments
    const regionSelect = document.getElementById('id_region');
    const prefectureSelect = document.getElementById('id_prefecture');
    const structureSelect = document.getElementById('id_structure_locale');
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('id_photo_principale');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('preview-img');
    const uploadContent = document.getElementById('upload-content');
    const photoError = document.getElementById('photo-error');
    const errorMessage = document.getElementById('error-message');
    const fileInfo = document.getElementById('file-info');

    // Gestion r√©gion/pr√©fecture/structure avec am√©liorations
    console.log('üåç Configuration des champs de localisation...');
    console.log('üìã Elements:', {regionSelect, prefectureSelect, structureSelect});
    
    if (regionSelect) {
        console.log('üìç Initialisation s√©lecteur r√©gion');
        console.log('üîç Options r√©gion disponibles:', regionSelect.options.length);
        
        regionSelect.addEventListener('change', function() {
            const regionId = this.value;
            console.log('üîÑ Changement r√©gion:', regionId);
            
            // Reset et loading states
            prefectureSelect.innerHTML = '<option value="">Chargement des pr√©fectures...</option>';
            prefectureSelect.disabled = true;
            structureSelect.innerHTML = '<option value="">Choisir d\'abord une pr√©fecture</option>';
            structureSelect.disabled = true;
            
            if (regionId) {
                const apiUrl = `/api/prefectures/?region=${regionId}`;
                console.log('üîó Requ√™te API pr√©fectures:', apiUrl);
                
                // V√©rifier que l'URL est correcte
                console.log('üåê URL compl√®te:', window.location.origin + apiUrl);
                
                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => {
                        console.log('üì° R√©ponse API pr√©fectures:', {
                            status: response.status,
                            statusText: response.statusText,
                            ok: response.ok,
                            headers: response.headers
                        });
                        
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error('‚ùå Erreur API - Contenu:', text);
                                throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}\n${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('üìä Pr√©fectures re√ßues:', data);
                        
                        if (!Array.isArray(data)) {
                            console.error('‚ùå Format de donn√©es incorrect:', typeof data, data);
                            throw new Error('Format de r√©ponse incorrect - attendu: Array');
                        }
                        
                        prefectureSelect.innerHTML = '<option value="">Choisir une pr√©fecture</option>';
                        data.forEach(prefecture => {
                            if (!prefecture.id || !prefecture.nom) {
                                console.warn('‚ö†Ô∏è Pr√©fecture incompl√®te:', prefecture);
                                return;
                            }
                            const option = document.createElement('option');
                            option.value = prefecture.id;
                            option.textContent = prefecture.nom;
                            prefectureSelect.appendChild(option);
                        });
                        prefectureSelect.disabled = false;
                        
                        console.log('‚úÖ Pr√©fectures charg√©es avec succ√®s:', data.length, '√©l√©ments');
                        
                        // Animation de succ√®s
                        prefectureSelect.classList.add('ring-2', 'ring-green-500');
                        setTimeout(() => {
                            prefectureSelect.classList.remove('ring-2', 'ring-green-500');
                        }, 1000);
                    })
                    .catch(error => {
                        console.error('‚ùå Erreur compl√®te:', error);
                        console.error('‚ùå Stack trace:', error.stack);
                        
                        const errorMsg = error.message || 'Erreur de chargement inconnue';
                        prefectureSelect.innerHTML = `<option value="">‚ùå ${errorMsg.substring(0, 50)}</option>`;
                        prefectureSelect.disabled = false;
                        
                        // Animation d'erreur
                        prefectureSelect.classList.add('ring-2', 'ring-red-500');
                        setTimeout(() => {
                            prefectureSelect.classList.remove('ring-2', 'ring-red-500');
                        }, 2000);
                        
                        // Alerte pour l'utilisateur
                        console.error('üí¨ Affichage erreur utilisateur...');
                    });
            } else {
                prefectureSelect.innerHTML = '<option value="">Choisir d\'abord une r√©gion</option>';
                prefectureSelect.disabled = false;
            }
        });
    }

    if (prefectureSelect) {
        prefectureSelect.addEventListener('change', function() {
            const prefectureId = this.value;
            
            structureSelect.innerHTML = '<option value="">Chargement...</option>';
            structureSelect.disabled = true;
            
            if (prefectureId) {
                const apiUrl = `/api/structures/?prefecture=${prefectureId}`;
                console.log('üîó Requ√™te API structures:', apiUrl);
                
                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => {
                        console.log('üì° R√©ponse API structures:', response.status, response.ok);
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error('‚ùå Erreur API structures - Contenu:', text);
                                throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('üìä Structures re√ßues:', data);
                        structureSelect.innerHTML = '<option value="">Aucune structure requise</option>';
                        data.forEach(structure => {
                            if (!structure.id || !structure.nom) {
                                console.warn('‚ö†Ô∏è Structure incompl√®te:', structure);
                                return;
                            }
                            const option = document.createElement('option');
                            option.value = structure.id;
                            option.textContent = `${structure.nom} (${structure.type_structure || 'Structure'})`;
                            structureSelect.appendChild(option);
                        });
                        structureSelect.disabled = false;
                        
                        console.log('‚úÖ Structures charg√©es avec succ√®s:', data.length, '√©l√©ments');
                        
                        // Animation de succ√®s
                        structureSelect.classList.add('ring-2', 'ring-green-500');
                        setTimeout(() => {
                            structureSelect.classList.remove('ring-2', 'ring-green-500');
                        }, 1000);
                    })
                    .catch(error => {
                        console.error('‚ùå Erreur structures:', error);
                        structureSelect.innerHTML = '<option value="">‚ùå Erreur de chargement</option>';
                        structureSelect.disabled = false;
                        
                        // Animation d'erreur
                        structureSelect.classList.add('ring-2', 'ring-red-500');
                        setTimeout(() => {
                            structureSelect.classList.remove('ring-2', 'ring-red-500');
                        }, 2000);
                    });
            } else {
                structureSelect.innerHTML = '<option value="">Choisir d\'abord une pr√©fecture</option>';
                structureSelect.disabled = false;
            }
        });
    }

    // Gestion upload photo avec am√©liorations
    if (dropzone && fileInput) {
        // Click sur la zone
        dropzone.addEventListener('click', (e) => {
            if (e.target.type !== 'button') {
                fileInput.click();
            }
        });
        
        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // Changement de fichier
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
    }

    function handleFile(file) {
        // Masquer les erreurs pr√©c√©dentes
        hideError();
        
        // Validation du fichier
        if (!validateFile(file)) {
            return;
        }
        
        // Affichage de l'aper√ßu
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            fileInfo.textContent = `${file.name} (${formatFileSize(file.size)})`;
            
            // Assigner le fichier au input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            // Afficher l'aper√ßu
            uploadContent.classList.add('hidden');
            preview.classList.remove('hidden');
            
            // Animation de succ√®s
            dropzone.classList.add('ring-4', 'ring-green-200', 'border-green-500');
            setTimeout(() => {
                dropzone.classList.remove('ring-4', 'ring-green-200');
            }, 1500);
        };
        reader.readAsDataURL(file);
    }

    function validateFile(file) {
        // V√©rifier le type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showError('Type de fichier non support√©. Utilisez JPG, PNG, GIF ou WebP.');
            return false;
        }
        
        // V√©rifier la taille (5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            showError(`Fichier trop volumineux (${formatFileSize(file.size)}). Taille maximum : 5MB.`);
            return false;
        }
        
        return true;
    }

    function showError(message) {
        errorMessage.textContent = message;
        photoError.classList.remove('hidden');
        
        // Animation d'erreur
        dropzone.classList.add('ring-4', 'ring-red-200', 'border-red-500');
        setTimeout(() => {
            dropzone.classList.remove('ring-4', 'ring-red-200');
        }, 3000);
    }

    function hideError() {
        photoError.classList.add('hidden');
        errorMessage.textContent = '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Fonction globale pour supprimer la photo
    window.removePhoto = function() {
        fileInput.value = '';
        fileInput.files = null;
        preview.classList.add('hidden');
        uploadContent.classList.remove('hidden');
        previewImg.src = '#';
        hideError();
        
        // Reset de l'apparence
        dropzone.classList.remove('border-green-500', 'ring-4', 'ring-green-200');
    }

    // Validation du formulaire avant soumission
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const nomObjet = document.getElementById('id_nom_objet').value.trim();
            const dateIncident = document.getElementById('id_date_incident').value;
            const lieuPrecis = document.getElementById('id_lieu_precis').value.trim();
            const region = document.getElementById('id_region').value;
            const prefecture = document.getElementById('id_prefecture').value;
            
            console.log('üîç Validation:', {
                nomObjet: !!nomObjet,
                dateIncident: !!dateIncident,
                lieuPrecis: !!lieuPrecis,
                region: !!region,
                prefecture: !!prefecture
            });
            
            if (!nomObjet || !dateIncident || !lieuPrecis || !region || !prefecture) {
                e.preventDefault();
                alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (nom, date, lieu, r√©gion, pr√©fecture).');
                return false;
            }
            
            // Ajouter un indicateur de chargement
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';
                console.log('üì§ Envoi du formulaire...');
            }
        });
    }
});
</script>
{% endblock %}