{% extends 'base.html' %}

{% block title %}Signaler un objet perdu{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            üîç D√©clarer un objet perdu
        </h1>

        {% if messages %}
        {% for message in messages %}
        <div
            class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300{% else %}bg-green-100 text-green-700 border border-green-300{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- Section type de d√©claration -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üîñ Type de d√©claration</h2>

                <div class="grid grid-cols-2 gap-4">
                    <div
                        class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-red-300 transition-colors">
                        {% if form.type_declaration.value == 'trouve' %}
                        <input type="radio" id="type_perdu" name="type_declaration" value="perdu"
                            class="mr-3 text-red-600 focus:ring-red-500">
                        {% else %}
                        <input type="radio" id="type_perdu" name="type_declaration" value="perdu" checked
                            class="mr-3 text-red-600 focus:ring-red-500">
                        {% endif %}
                        <label for="type_perdu" class="flex-1 cursor-pointer">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üò¢</span>
                                <div>
                                    <p class="font-medium text-gray-900">Objet perdu</p>
                                    <p class="text-sm text-gray-600">J'ai perdu quelque chose</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div
                        class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-green-300 transition-colors">
                        {% if form.type_declaration.value == 'trouve' %}
                        <input type="radio" id="type_retrouve" name="type_declaration" value="trouve" checked
                            class="mr-3 text-green-600 focus:ring-green-500">
                        {% else %}
                        <input type="radio" id="type_retrouve" name="type_declaration" value="trouve"
                            class="mr-3 text-green-600 focus:ring-green-500">
                        {% endif %}
                        <label for="type_retrouve" class="flex-1 cursor-pointer">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üòä</span>
                                <div>
                                    <p class="font-medium text-gray-900">Objet retrouv√©</p>
                                    <p class="text-sm text-gray-600">J'ai trouv√© quelque chose</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Section informations de base -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üìã Informations de base</h2>

                <div class="space-y-4">
                    <div>
                        <label for="id_nom_objet" class="block text-sm font-medium text-gray-700 mb-1">
                            Nom de l'objet <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="nom_objet" id="id_nom_objet" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Ex: iPhone 13, portefeuille en cuir, cl√©s de voiture..."
                            value="{{ form.nom_objet.value|default:'' }}">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="id_date_incident" class="block text-sm font-medium text-gray-700 mb-1">
                                Date de perte <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="date_incident" id="id_date_incident" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                value="{{ form.date_incident.value|default:'' }}">
                        </div>

                        <div>
                            <label for="id_lieu_precis" class="block text-sm font-medium text-gray-700 mb-1">
                                Lieu pr√©cis <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="lieu_precis" id="id_lieu_precis" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Ex: March√© de Kpalim√©, Gare routi√®re..."
                                value="{{ form.lieu_precis.value|default:'' }}">
                        </div>
                    </div>

                    <div>
                        <label for="id_description" class="block text-sm font-medium text-gray-700 mb-1">
                            Description d√©taill√©e
                        </label>
                        <textarea name="description" id="id_description" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Couleur, marque, mod√®le, signes particuliers...">{{ form.description.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üìç Localisation</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="id_region" class="block text-sm font-medium text-gray-700 mb-1">
                            R√©gion
                        </label>
                        <select name="region" id="id_region"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Choisir une r√©gion</option>
                            {% for region in regions %}
                            {% if form.region.value == region.id %}
                            <option value="{{ region.id }}" selected>{{ region.nom }}</option>
                            {% else %}
                            <option value="{{ region.id }}">{{ region.nom }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="id_prefecture" class="block text-sm font-medium text-gray-700 mb-1">
                            Pr√©fecture
                        </label>
                        <select name="prefecture" id="id_prefecture"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            disabled>
                            <option value="">Choisir d'abord une r√©gion</option>
                        </select>
                    </div>

                    <div>
                        <label for="id_structure_locale" class="block text-sm font-medium text-gray-700 mb-1">Structure
                            locale</label>
                        <select name="structure_locale" id="id_structure_locale"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            disabled>
                            <option value="">Choisir d'abord une pr√©fecture</option>
                        </select>
                    </div>
                </div>

                <!-- Carte interactive pour g√©olocalisation -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üìç Localisation sur la carte (optionnel mais recommand√©)
                    </label>
                    <p class="text-sm text-gray-600 mb-3">
                        Cliquez sur la carte pour marquer l'emplacement exact, ou utilisez le bouton de g√©olocalisation
                    </p>
                    <div class="mb-3 flex gap-2">
                        <button type="button" id="btn-geolocaliser"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Me g√©olocaliser
                        </button>
                        <button type="button" id="btn-clear-map"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            üóëÔ∏è Effacer
                        </button>
                    </div>
                    <div id="map" class="w-full h-96 rounded-lg border-2 border-gray-300 shadow-sm"></div>
                    <div id="coords-display"
                        class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700">
                        üìç Coordonn√©es : <span id="coords-text" class="font-mono"></span>
                    </div>
                </div>

                <!-- Champs cach√©s pour les coordonn√©es GPS -->
                <input type="hidden" name="latitude" id="id_latitude" value="">
                <input type="hidden" name="longitude" id="id_longitude" value="">
            </div>

            <!-- Section photo -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üì∏ Photo</h2>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors"
                    id="dropzone">
                    <div id="upload-content">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg font-medium text-gray-600 mb-2">Cliquez ici ou glissez votre photo</p>
                        <p class="text-sm text-gray-500 mb-4">PNG, JPG, GIF (max 5MB)</p>
                        <button type="button"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                            onclick="document.getElementById('id_photo_principale').click()">
                            Choisir un fichier
                        </button>
                        <input type="file" name="photo_principale" id="id_photo_principale" accept="image/*"
                            class="hidden">
                    </div>

                    <!-- Aper√ßu -->
                    <div id="preview" class="hidden">
                        <img id="preview-img" src="#" alt="Aper√ßu"
                            class="max-w-xs max-h-48 mx-auto rounded-lg shadow-md mb-4">
                        <div
                            class="bg-green-100 text-green-800 px-4 py-2 rounded-lg inline-flex items-center space-x-2 mb-4">
                            <i class="fas fa-check-circle"></i>
                            <span id="file-info">Photo s√©lectionn√©e</span>
                        </div>
                        <br>
                        <button type="button" onclick="removePhoto()"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>

                    <!-- Messages d'erreur -->
                    <div id="photo-error" class="hidden mt-4 bg-red-100 text-red-700 px-4 py-2 rounded-lg">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="error-message"></span>
                    </div>
                </div>
            </div>

            <!-- Section commentaires -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">üí¨ Commentaires suppl√©mentaires</h2>
                <div>
                    <label for="id_commentaire_declarant" class="block text-sm font-medium text-gray-700 mb-1">
                        Informations suppl√©mentaires
                    </label>
                    <textarea name="commentaire_declarant" id="id_commentaire_declarant" rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Circonstances de la perte, r√©compense, etc...">{{ form.commentaire_declarant.value|default:'' }}</textarea>
                </div>
            </div>

            <!-- Boutons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
                <button type="submit"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-medium transition duration-200">
                    üìù D√©clarer
                </button>
                <a href="{% url 'signalements_list' %}"
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-medium transition duration-200 text-center">
                    ‚Ü©Ô∏è Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const regionSelect = document.getElementById('id_region');
        const prefectureSelect = document.getElementById('id_prefecture');
        const structureSelect = document.getElementById('id_structure_locale');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('id_photo_principale');
        const preview = document.getElementById('preview');
        const previewImg = document.getElementById('preview-img');
        const uploadContent = document.getElementById('upload-content');
        const photoError = document.getElementById('photo-error');
        const errorMessage = document.getElementById('error-message');
        const fileInfo = document.getElementById('file-info');

        // Population Pr√©fectures
        if (regionSelect && prefectureSelect) {
            regionSelect.addEventListener('change', function () {
                const regionId = this.value;
                prefectureSelect.innerHTML = '<option value="">Chargement...</option>';
                prefectureSelect.disabled = true;
                structureSelect.innerHTML = '<option value="">Choisir d\'abord une pr√©fecture</option>';
                structureSelect.disabled = true;

                if (regionId) {
                    fetch(`/api/prefectures/region/${regionId}/`)
                        .then(r => r.json())
                        .then(data => {
                            prefectureSelect.innerHTML = '<option value="">Choisir une pr√©fecture</option>';
                            data.forEach(p => {
                                const o = document.createElement('option');
                                o.value = p.id; o.textContent = p.nom;
                                prefectureSelect.appendChild(o);
                            });
                            prefectureSelect.disabled = false;
                        });
                }
            });
        }

        // Population Structures
        if (prefectureSelect && structureSelect) {
            prefectureSelect.addEventListener('change', function () {
                const prefectureId = this.value;
                structureSelect.innerHTML = '<option value="">Chargement...</option>';
                structureSelect.disabled = true;

                if (prefectureId) {
                    fetch(`/api/structures/prefecture/${prefectureId}/`)
                        .then(r => r.json())
                        .then(data => {
                            structureSelect.innerHTML = '<option value="">Aucune structure requise</option>';
                            data.forEach(s => {
                                const o = document.createElement('option');
                                o.value = s.id; o.textContent = s.nom;
                                structureSelect.appendChild(o);
                            });
                            structureSelect.disabled = false;
                        });
                }
            });
        }

        // Gestion Photo
        if (dropzone && fileInput) {
            dropzone.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleFile(e.target.files[0]);
            });

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('border-blue-500', 'bg-blue-50');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
            });
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Veuillez s√©lectionner une image.');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('Image trop volumineuse (max 5MB).');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                fileInfo.textContent = file.name;
                uploadContent.classList.add('hidden');
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        window.removePhoto = function () {
            fileInput.value = '';
            preview.classList.add('hidden');
            uploadContent.classList.remove('hidden');
            previewImg.src = '#';
        };

        // ===== GESTION DE LA CARTE LEAFLET =====
        let map, marker;
        const latInput = document.getElementById('id_latitude');
        const lonInput = document.getElementById('id_longitude');
        const coordsDisplay = document.getElementById('coords-display');
        const coordsText = document.getElementById('coords-text');
        const btnGeolocaliser = document.getElementById('btn-geolocaliser');
        const btnClearMap = document.getElementById('btn-clear-map');

        // Initialiser la carte centr√©e sur Lom√©, Togo
        map = L.map('map').setView([6.1256, 1.2223], 13);

        // Ajouter les tuiles OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Fonction pour ajouter/d√©placer le marqueur
        function setMarker(lat, lng) {
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng], {
                    draggable: true
                }).addTo(map);

                // Permettre de d√©placer le marqueur
                marker.on('dragend', function (e) {
                    const pos = e.target.getLatLng();
                    updateCoordinates(pos.lat, pos.lng);
                });
            }

            updateCoordinates(lat, lng);
            map.setView([lat, lng], 15);
        }

        // Fonction pour mettre √† jour les coordonn√©es
        function updateCoordinates(lat, lng) {
            latInput.value = lat.toFixed(6);
            lonInput.value = lng.toFixed(6);
            coordsText.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            coordsDisplay.classList.remove('hidden');
        }

        // Clic sur la carte pour placer le marqueur
        map.on('click', function (e) {
            setMarker(e.latlng.lat, e.latlng.lng);
        });

        // Bouton de g√©olocalisation
        btnGeolocaliser.addEventListener('click', function () {
            if (!navigator.geolocation) {
                alert('La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }

            btnGeolocaliser.disabled = true;
            btnGeolocaliser.innerHTML = '<span class="animate-pulse">üìç Localisation en cours...</span>';

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setMarker(lat, lng);
                    btnGeolocaliser.disabled = false;
                    btnGeolocaliser.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Me g√©olocaliser
                    `;
                },
                function (error) {
                    btnGeolocaliser.disabled = false;
                    btnGeolocaliser.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Me g√©olocaliser
                    `;
                    alert('Impossible d\'obtenir votre position. Veuillez v√©rifier les autorisations de g√©olocalisation.');
                }
            );
        });

        // Bouton pour effacer le marqueur
        btnClearMap.addEventListener('click', function () {
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
            latInput.value = '';
            lonInput.value = '';
            coordsDisplay.classList.add('hidden');
            map.setView([6.1256, 1.2223], 13);
        });
    });
</script>
{% endblock %}