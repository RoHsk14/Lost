{% extends 'agent/base.html' %}

{% block title %}Vérification d'identité - TogoRetrouve{% endblock %}

{% block page_title %}Documents & Vérifications{% endblock %}
{% block page_subtitle %}Visualisation des documents et gestion des discussions{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Statistiques des documents -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100">
                    <i class="fas fa-file-alt text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Documents reçus</h3>
                    <p class="text-2xl font-bold text-gray-900" id="documents-count">12</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100">
                    <i class="fas fa-comments text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Discussions actives</h3>
                    <p class="text-2xl font-bold text-gray-900" id="discussions-count">5</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100">
                    <i class="fas fa-eye text-purple-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Documents vus</h3>
                    <p class="text-2xl font-bold text-gray-900" id="vus-count">8</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Liste des documents récents -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <i class="fas fa-folder-open mr-2 text-blue-600"></i>
                    Documents récents
                </h3>
                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-medium">
                    12 nouveaux
                </span>
            </div>
        </div>
        
        <div class="divide-y divide-gray-200" id="documents-list">
            <!-- Les documents seront chargés dynamiquement -->
            <div class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                <p class="text-sm text-gray-500">Chargement des documents...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Charger les documents récents
function loadDocuments() {
    console.log('Démarrage du chargement des documents...');
    fetch('/agent/documents/')
        .then(response => {
            console.log('Réponse reçue:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Données reçues:', data);
            const documentsList = document.getElementById('documents-list');
            
            if (data.error || !data.success) {
                console.error('Erreur API:', data.error);
                documentsList.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                        <p class="text-sm text-red-500 font-medium">Erreur de chargement</p>
                        <p class="text-xs text-gray-500 mt-1">${data.error || 'Erreur inconnue'}</p>
                        <button onclick="loadDocuments()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm underline">
                            Réessayer
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log(`Nombre de documents trouvés: ${data.documents ? data.documents.length : 0}`);
            
            // Mettre à jour les compteurs
            document.getElementById('documents-count').textContent = data.count || 0;
            document.getElementById('discussions-count').textContent = data.discussions_count || 0;
            document.getElementById('vus-count').textContent = data.vus_count || 0;
            
            if (!data.documents || data.documents.length === 0) {
                documentsList.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun document récent</h3>
                        <p class="text-gray-500">Aucun nouveau document à examiner pour le moment.</p>
                        <p class="text-xs text-gray-400 mt-2">Les documents des réclamations qui vous sont assignées apparaîtront ici.</p>
                    </div>
                `;
                return;
            }

            let documentsHTML = '';
            data.documents.forEach(doc => {
                const statutBadge = doc.verifie ? 
                    `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check mr-1"></i>
                        Vérifié
                    </span>` :
                    `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                        <i class="fas fa-clock mr-1"></i>
                        À examiner
                    </span>`;
                
                const assigneBadge = doc.agent_assigne ?
                    `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                        <i class="fas fa-user-check mr-1"></i>
                        Vous êtes assigné
                    </span>` :
                    `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Votre zone
                    </span>`;
                    
                documentsHTML += `
                    <div class="p-6 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start space-x-4">
                            <!-- Icône du document -->
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                    <i class="fas ${doc.icon} text-xl ${doc.color}"></i>
                                </div>
                            </div>
                            
                            <!-- Informations du document -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-lg font-medium text-gray-900 truncate">${doc.fileName}</h4>
                                    <span class="text-sm text-gray-500">${doc.size}</span>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                                    <div>
                                        <p class="text-sm text-gray-600"><strong>Type:</strong> ${doc.type}</p>
                                        <p class="text-sm text-gray-600"><strong>Expéditeur:</strong> ${doc.expediteur}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600"><strong>Objet concerné:</strong> ${doc.objet}</p>
                                        <p class="text-sm text-gray-600"><strong>Date d'envoi:</strong> ${doc.date}</p>
                                    </div>
                                </div>
                                
                                <!-- Barre d'état -->
                                <div class="flex items-center space-x-2 mb-3 flex-wrap">
                                    ${statutBadge}
                                    ${assigneBadge}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-user mr-1"></i>
                                        ${doc.expediteur}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex-shrink-0 flex flex-col space-y-2">
                                <button onclick="voirDocument('${doc.url}', '${doc.id}', '${doc.source}')" 
                                        class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    <i class="fas fa-eye mr-1"></i>
                                    Voir
                                </button>
                                <button onclick="discuterDocument('${doc.id}', '${doc.expediteur}', '${doc.source}', ${doc.conversationId || doc.reclamationId})" 
                                        class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                                    <i class="fas fa-comments mr-1"></i>
                                    Discuter
                                </button>
                                <button onclick="voirObjet(${doc.objetId})" 
                                        class="inline-flex items-center px-3 py-1.5 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                                    <i class="fas fa-box mr-1"></i>
                                    Voir l'objet
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            documentsList.innerHTML = documentsHTML;
        })
        .catch(error => {
            console.error('Erreur lors du chargement des documents:', error);
            document.getElementById('documents-list').innerHTML = `
                <div class="p-8 text-center">
                    <i class="fas fa-wifi text-red-400 text-2xl mb-2"></i>
                    <p class="text-sm text-red-500 font-medium">Erreur de connexion</p>
                    <p class="text-xs text-gray-500 mt-1">${error.message}</p>
                    <button onclick="loadDocuments()" class="mt-3 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                        Réessayer
                    </button>
                </div>
            `;
        });
}

// Actions sur les documents
function voirDocument(documentUrl, documentId, source) {
    if (documentUrl) {
        // Ouvrir le document dans un nouvel onglet
        window.open(documentUrl, '_blank');
        
        // Marquer le document comme vu selon sa source
        marquerVu(documentId, source);
    } else {
        alert('Document non disponible');
    }
}

function discuterDocument(documentId, expediteur, source, contextId) {
    console.log('Discuter avec:', expediteur, 'pour document:', documentId, 'source:', source);
    
    if (source === 'conversation') {
        // Si c'est un fichier de conversation, aller directement à la conversation dans le chat
        window.location.href = `/agent/chat/?conversation_id=${contextId}`;
    } else if (source === 'réclamation') {
        // Si c'est un document de réclamation, aller au chat avec l'ID de réclamation
        window.location.href = `/agent/chat/?reclamation_id=${contextId}`;
    } else {
        // Fallback : aller au chat général
        window.location.href = `/agent/chat/`;
    }
}

function voirObjet(objetId) {
    if (objetId) {
        // Rediriger vers la page de l'objet/signalement
        console.log('Voir objet:', objetId);
        window.location.href = `/agent/signalement/${objetId}/`;
    } else {
        alert('Objet non disponible');
    }
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadDocuments();
    
    // Actualiser les documents toutes les 60 secondes
    setInterval(loadDocuments, 60000);
});

// Fonction pour marquer un document comme vu
function marquerVu(documentId, source) {
    console.log('Marquage document comme vu:', documentId, 'source:', source);
    
    // Extraction de l'ID réel selon la source
    let realId = documentId;
    if (documentId.startsWith('rec_')) {
        realId = documentId.replace('rec_', '');
        source = 'reclamation';
    } else if (documentId.startsWith('msg_')) {
        realId = documentId.replace('msg_', '');
        source = 'message';
    }
    
    // Appel API pour marquer comme vu
    const url = source === 'message' ? `/agent/marquer-message-lu/${realId}/` : `/agent/marquer-document-vu/${realId}/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Document marqué comme vu avec succès');
            // Recharger les documents pour mettre à jour les statuts
            setTimeout(loadDocuments, 1000);
        } else {
            console.error('Erreur marquage:', data.error);
        }
    })
    .catch(error => {
        console.error('Erreur lors du marquage:', error);
    });
}
</script>
{% endblock %}