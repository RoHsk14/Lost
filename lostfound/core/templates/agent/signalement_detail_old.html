{% extends 'agent/base.html' %}
{% csrf_token %}

{% block title %}{{ signalement.nom_objet }} - D√©tails signalement{% endblock %}

{% block page_title %}D√©tails du signalement{% endblock %}
{% block page_subtitle %}{{ signalement.numero_declaration }} - {{ signalement.nom_objet }}{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Colonne principale - D√©tails du signalement -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Informations principales -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Informations de l'objet</h3>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                            {% if signalement.statut == 'cree' %}bg-yellow-100 text-yellow-800
                            {% elif signalement.statut == 'valide' %}bg-blue-100 text-blue-800
                            {% elif signalement.statut == 'publie' and signalement.type_declaration == 'perdu' %}bg-orange-100 text-orange-800
                            {% elif signalement.statut == 'publie' %}bg-green-100 text-green-800
                            {% elif signalement.statut == 'restitue' %}bg-purple-100 text-purple-800
                            {% elif signalement.statut == 'rejete' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            <i class="fas fa-circle text-xs mr-2"></i>
                            {% if signalement.statut == 'publie' and signalement.type_declaration == 'perdu' %}
                                Retrouv√©
                            {% else %}
                                {{ signalement.get_statut_display }}
                            {% endif %}
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                            {% if signalement.type_declaration == 'trouve' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            <i class="fas fa-{% if signalement.type_declaration == 'trouve' %}search{% else %}exclamation-triangle{% endif %} text-xs mr-2"></i>
                            {{ signalement.get_type_declaration_display }}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">{{ signalement.nom_objet }}</h4>
                        <p class="text-gray-700 mb-4">{{ signalement.description }}</p>
                        
                        <dl class="space-y-3">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Num√©ro de d√©claration</dt>
                                <dd class="text-sm text-gray-900 font-mono">{{ signalement.numero_declaration }}</dd>
                            </div>
                            {% if signalement.categorie %}
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Cat√©gorie</dt>
                                    <dd class="text-sm text-gray-900">{{ signalement.categorie.nom }}</dd>
                                </div>
                            {% endif %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Date de l'incident</dt>
                                <dd class="text-sm text-gray-900">{{ signalement.date_incident|date:"d/m/Y" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Date de d√©claration</dt>
                                <dd class="text-sm text-gray-900">{{ signalement.date_declaration|date:"d/m/Y √† H:i" }}</dd>
                            </div>
                        </dl>
                    </div>
                    
                    <div>
                        {% if signalement.photo_principale %}
                            <img src="{{ signalement.photo_principale.url }}" 
                                 alt="{{ signalement.nom_objet }}" 
                                 class="w-full h-64 object-cover rounded-lg shadow-sm">
                        {% else %}
                            <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center">
                                <div class="text-center text-gray-400">
                                    <i class="fas fa-image text-4xl mb-2"></i>
                                    <p>Aucune photo disponible</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Localisation -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Localisation</h3>
            </div>
            <div class="p-6">
                <dl class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {% if signalement.region %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">R√©gion</dt>
                            <dd class="text-sm text-gray-900">{{ signalement.region.nom }}</dd>
                        </div>
                    {% endif %}
                    {% if signalement.prefecture %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Pr√©fecture</dt>
                            <dd class="text-sm text-gray-900">{{ signalement.prefecture.nom }}</dd>
                        </div>
                    {% endif %}
                    {% if signalement.structure_locale %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Structure locale</dt>
                            <dd class="text-sm text-gray-900">{{ signalement.structure_locale.nom }}</dd>
                        </div>
                    {% endif %}
                </dl>
                {% if signalement.lieu_precis %}
                    <div class="mt-4">
                        <dt class="text-sm font-medium text-gray-500">Lieu pr√©cis</dt>
                        <dd class="text-sm text-gray-900 mt-1">{{ signalement.lieu_precis }}</dd>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Informations du d√©clarant -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">D√©clarant</h3>
            </div>
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-lg font-bold text-gray-600 mr-4">
                        {{ signalement.declarant.first_name|first|default:signalement.declarant.username|first|upper }}
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900">{{ signalement.declarant.get_full_name|default:signalement.declarant.username }}</h4>
                        <p class="text-sm text-gray-600">{{ signalement.declarant.email }}</p>
                        {% if signalement.declarant.telephone %}
                            <p class="text-sm text-gray-600">{{ signalement.declarant.telephone }}</p>
                        {% endif %}
                    </div>
                </div>
                
                {% if signalement.commentaire_declarant %}
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                        <h5 class="text-sm font-medium text-blue-900 mb-2">Commentaire du d√©clarant</h5>
                        <p class="text-sm text-blue-800">{{ signalement.commentaire_declarant }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- R√©clamations -->
        {% if reclamations %}
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">R√©clamations ({{ reclamations|length }})</h3>
                </div>
                <div class="divide-y divide-gray-200">
                    {% for reclamation in reclamations %}
                        <div class="p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <h4 class="text-md font-medium text-gray-900 mr-4">{{ reclamation.reclamant.get_full_name|default:reclamation.reclamant.username }}</h4>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                            {% if reclamation.statut == 'soumise' %}bg-orange-100 text-orange-800
                                            {% elif reclamation.statut == 'en_cours' %}bg-blue-100 text-blue-800
                                            {% elif reclamation.statut == 'approuvee' %}bg-green-100 text-green-800
                                            {% elif reclamation.statut == 'rejetee' %}bg-red-100 text-red-800
                                            {% endif %}">
                                            {{ reclamation.get_statut_display }}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2">{{ reclamation.numero_reclamation }} - {{ reclamation.date_reclamation|date:"d/m/Y √† H:i" }}</p>
                                    <p class="text-sm text-gray-800">{{ reclamation.justification|truncatechars:200 }}</p>
                                    
                                    {% if reclamation.pieces_justificatives.exists %}
                                        <div class="mt-3">
                                            <p class="text-xs text-gray-500 mb-2">{{ reclamation.pieces_justificatives.count }} pi√®ce(s) justificative(s)</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="ml-4">
                                    {% if reclamation.statut == 'soumise' %}
                                        <a href="{% url 'togo_agent:verifier_reclamation' reclamation.id %}" 
                                           class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                                            <i class="fas fa-check mr-2"></i>
                                            V√©rifier
                                        </a>
                                    {% elif reclamation.statut == 'approuvee' %}
                                        <button onclick="validerRestitution({{ reclamation.id }})" 
                                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                            <i class="fas fa-handshake mr-2"></i>
                                            Restituer
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        
        <!-- Commentaires publics -->
        {% if commentaires %}
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Commentaires publics ({{ commentaires|length }})</h3>
                </div>
                <div class="divide-y divide-gray-200">
                    {% for commentaire in commentaires %}
                        <div class="p-6">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-sm font-bold text-gray-600 mr-3">
                                    {{ commentaire.get_display_name|first|upper }}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center mb-1">
                                        <h4 class="text-sm font-medium text-gray-900">{{ commentaire.get_display_name }}</h4>
                                        <span class="ml-2 text-xs text-gray-500">{{ commentaire.date_creation|date:"d/m/Y √† H:i" }}</span>
                                    </div>
                                    <p class="text-sm text-gray-700">{{ commentaire.contenu }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Colonne lat√©rale - Actions et historique -->
    <div class="space-y-6">
        <!-- Actions rapides -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Actions</h3>
            </div>
            <div class="p-6 space-y-3">
                {% if peut_valider %}
                    <form method="post" action="{% url 'togo_agent:valider_signalement' signalement.id %}" 
                          onsubmit="return confirm('√ätes-vous s√ªr de vouloir valider ce signalement ?')" 
                          style="margin: 0;">
                        {% csrf_token %}
                        <input type="hidden" name="commentaire_agent" value="Valid√© via interface agent">
                        <button type="submit" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                            <i class="fas fa-check mr-2"></i>
                            Valider le signalement
                        </button>
                    </form>
                {% endif %}
                
                {% if peut_marquer_retrouve %}
                    <form method="post" action="{% url 'togo_agent:marquer_retrouve' signalement.id %}" 
                          onsubmit="return confirm('√ätes-vous s√ªr que cet objet a √©t√© retrouv√© ?')" 
                          style="margin: 0;">
                        {% csrf_token %}
                        <input type="hidden" name="commentaire_agent" value="Objet retrouv√©">
                        <button type="submit" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>
                            Retrouv√©
                        </button>
                    </form>
                {% endif %}
                
                {% if peut_marquer_restitue %}
                    <form method="post" action="{% url 'togo_agent:marquer_restitue' signalement.id %}" 
                          onsubmit="return confirm('Confirmez-vous la restitution de cet objet √† son propri√©taire ?')" 
                          style="margin: 0;">
                        {% csrf_token %}
                        <input type="hidden" name="commentaire_agent" value="Objet restitu√© au propri√©taire">
                        <button type="submit" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">
                            <i class="fas fa-handshake mr-2"></i>
                            Retourn√© au propri√©taire
                        </button>
                    </form>
                {% endif %}
                
                {% if peut_publier %}
                    <a href="#"
                       onclick="alert('Fonctionnalit√© de publication en cours de d√©veloppement.')" 
                       class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 no-underline">
                        <i class="fas fa-share mr-2"></i>
                        Publier
                    </a>
                {% endif %}
                
                <button onclick="startChat({{ signalement.id }})" id="chat-button-{{ signalement.id }}"
                   class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-comments mr-2"></i>
                    <span class="chat-btn-text">Chat temps r√©el</span>
                    <i class="fas fa-spinner fa-spin ml-2 hidden chat-loading"></i>
                </button>
                
                <a href="{% url 'togo_agent:generer_rapport' signalement.id %}" 
                   target="_blank"
                   class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 no-underline">
                    <i class="fas fa-file-alt mr-2"></i>
                    G√©n√©rer un rapport
                </a>
            </div>
        </div>
        
        <!-- Commentaire agent -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Notes internes</h3>
            </div>
            <div class="p-6">
                <form id="form-commentaire-agent">
                    <textarea id="commentaire-agent" rows="4" 
                              placeholder="Ajouter une note interne visible uniquement par les agents..." 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">{{ signalement.commentaire_agent }}</textarea>
                    <button type="submit" class="mt-3 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700">
                        <i class="fas fa-save mr-2"></i>
                        Sauvegarder la note
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Historique des actions -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Historique</h3>
            </div>
            <div class="p-6">
                <div class="flow-root">
                    <ul class="-mb-8">
                        {% for action in historique %}
                            <li>
                                <div class="relative pb-8">
                                    {% if not forloop.last %}
                                        <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200"></span>
                                    {% endif %}
                                    <div class="relative flex space-x-3">
                                        <div>
                                            <span class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center ring-8 ring-white">
                                                <i class="fas fa-{% if action.action == 'declaration_validee' %}check{% elif action.action == 'reclamation_approuvee' %}thumbs-up{% elif action.action == 'objet_restitue' %}handshake{% else %}info{% endif %} text-gray-600 text-sm"></i>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                            <div>
                                                <p class="text-sm text-gray-500">{{ action.get_action_display }}</p>
                                                {% if action.description %}
                                                    <p class="text-xs text-gray-400 mt-1">{{ action.description }}</p>
                                                {% endif %}
                                                {% if action.utilisateur %}
                                                    <p class="text-xs text-gray-400">par {{ action.utilisateur.get_full_name|default:action.utilisateur.username }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="text-right text-xs whitespace-nowrap text-gray-500">
                                                <time datetime="{{ action.date_action|date:'Y-m-d' }}">{{ action.date_action|timesince }}</time>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        {% empty %}
                            <li class="text-center text-gray-500">
                                <i class="fas fa-history text-gray-400 text-2xl mb-2"></i>
                                <p>Aucune action enregistr√©e</p>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function validerSignalement() {
    const commentaire = prompt('Commentaire de validation (optionnel):');
    if (commentaire !== null) {  // null si annul√©
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "togo_agent:valider_signalement" signalement.id %}';
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfToken);
        
        const commentaireInput = document.createElement('input');
        commentaireInput.type = 'hidden';
        commentaireInput.name = 'commentaire_agent';
        commentaireInput.value = commentaire;
        form.appendChild(commentaireInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function publierSignalement() {
    if (confirm('√ätes-vous s√ªr de vouloir publier ce signalement ?')) {
        // Impl√©menter la logique de publication
        console.log('Publication du signalement');
    }
}

function demarrerConversation() {
    // Rediriger vers la messagerie avec une nouvelle conversation
    window.location.href = '{% url "togo_agent:messagerie" %}';
}

function demarrerConversation() {
    window.location.href = '{% url "togo_agent:contacter_declarant" signalement.id %}';
}

function genererRapport() {
    // G√©n√©rer un rapport PDF
    window.open('{% url "togo_agent:generer_rapport" signalement.id %}', '_blank');
}

function validerRestitution(reclamationId) {
    if (confirm('Confirmer la restitution de cet objet ? Cette action est irr√©versible.')) {
        fetch(`{% url 'togo_agent:valider_restitution' 0 %}`.replace('0', reclamationId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                if (data.recu_url) {
                    window.open(data.recu_url, '_blank');
                }
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur s\'est produite.');
        });
    }
}

// Sauvegarde des notes internes
document.getElementById('form-commentaire-agent').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const commentaire = document.getElementById('commentaire-agent').value;
    
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'update_comment',
            commentaire: commentaire
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Note sauvegard√©e avec succ√®s');
        } else {
            alert('Erreur lors de la sauvegarde');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur s\'est produite');
    });
});

// Fonction pour d√©marrer un chat
function startChat(signalementId) {
    const button = document.getElementById(`chat-button-${signalementId}`);
    const btnText = button.querySelector('.chat-btn-text');
    const loader = button.querySelector('.chat-loading');
    
    // Afficher le chargement
    btnText.textContent = 'Ouverture du chat...';
    loader.classList.remove('hidden');
    button.disabled = true;
    
    console.log('üîç D√©marrage requ√™te chat pour signalement:', signalementId);
    
    fetch('/api/conversations/create-django/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            signalement_id: signalementId
        })
    })
    .then(response => {
        console.log('üîç Status de la r√©ponse:', response.status);
        console.log('üîç R√©ponse OK?', response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('üîç R√©ponse API compl√®te:', data);
        
        if (data.conversation_id) {
            console.log('‚úÖ Conversation ID trouv√©:', data.conversation_id);
            // Rediriger vers l'interface de chat s√©par√©e avec la conversation ouverte
            window.location.href = `/agent/chat/?openChat=${data.conversation_id}`;
        } else {
            console.error('‚ùå Pas de conversation_id dans la r√©ponse:', data);
            // R√©initialiser le bouton en cas d'erreur
            btnText.textContent = 'Chat temps r√©el';
            loader.classList.add('hidden');
            button.disabled = false;
            alert('Erreur: ' + (data.error || 'Impossible de cr√©er la conversation'));
        }
    })
    .catch(error => {
        // R√©initialiser le bouton en cas d'erreur
        btnText.textContent = 'Chat temps r√©el';
        loader.classList.add('hidden');
        button.disabled = false;
        console.error('Erreur:', error);
        alert('Une erreur s\'est produite lors de l\'ouverture du chat');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}